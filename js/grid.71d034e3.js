"use strict";(self["webpackChunkwebgl_polygon"]=self["webpackChunkwebgl_polygon"]||[]).push([[276],{970:function(t,e,i){i.r(e),i.d(e,{default:function(){return x}});var a=function(){var t=this,e=t._self._c;t._self._setupProxy;return e("div",{staticClass:"flex"},[e("Viewport",{ref:"view",attrs:{width:t.width,height:t.height,preserveDrawingBuffer:"true"},on:{"context-ready":t.OnContextReady},nativeOn:{wheel:function(e){return e.preventDefault(),t.OnWheel(e.deltaY,e.ctrlKey,e.altKey)},mousemove:function(e){return t.OnMouseMove(e.buttons,e.ctrlKey,e.movementX,e.movementY)},drop:function(e){return e.stopPropagation(),e.preventDefault(),t.OnLoadImage(e.dataTransfer.files[0])},dragover:function(t){return t.stopPropagation(),t.preventDefault(),(()=>0).apply(null,arguments)}}}),e("aside",[e("fa-icon",{staticClass:"panelHelpTrigger",attrs:{icon:"question-circle"}}),e("div",{staticClass:"panelHelpContent"},[e("ul",[e("li",[e("fa-icon",{attrs:{icon:"mouse"}}),t._v("  "),e("span",{staticClass:"accent"},[t._v("LMB")]),t._v(" - move grid ")],1),e("li",[e("fa-icon",{attrs:{icon:"mouse"}}),t._v("  "),e("span",{staticClass:"accent"},[t._v("WHEEL")]),t._v(" - scale grid ")],1),t._m(0),e("li",[e("fa-icon",{attrs:{icon:"mouse"}}),t._v("  "),e("span",{staticClass:"accent"},[t._v("WHEEL")]),t._v(" + ALT - rotate image ")],1)])]),e("table",[t._m(1),e("tbody",[e("tr",[e("td",[t._v("Offset")]),e("td",[t._v(t._s(t.gridState[0]))]),e("td",[t._v(t._s(t.gridState[1]))])]),e("tr",[e("td",[t._v("Scale")]),e("td",{attrs:{colspan:"2"}},[t._v(t._s(t.GridScale.toFixed(4)))])])])]),e("table",[t._m(2),e("tbody",[e("tr",[e("td",[t._v("Offset")]),e("td",[t._v(t._s(t.imageState[0].toFixed(1)))]),e("td",[t._v(t._s(t.imageState[1].toFixed(1)))])]),e("tr",[e("td",[t._v("Angle")]),e("td",{attrs:{colspan:"2"}},[t._v(t._s(t.ImageAngleDegrees.toFixed(1)))])]),e("tr",[e("td",[t._v("Scale")]),e("td",{attrs:{colspan:"2"}},[t._v(t._s(t.ImageScale.toFixed(4)))])])])]),e("div",{staticClass:"actions"},[e("div",{staticClass:"actions-group"},[e("button",{staticClass:"rightMargin",attrs:{disabled:t.NoImage},on:{click:t.CenterImage}},[t._v("Center image")]),e("button",{on:{click:t.Preview}},[t._v("Save")])]),e("button",{attrs:{disabled:t.NoImage},on:{click:t.AlignToGrid}},[t._v("Align to grid")])])],1)],1)},s=[function(){var t=this,e=t._self._c;t._self._setupProxy;return e("li",[t._v(" Image controlled in the same way by holding "),e("span",{staticClass:"accent"},[t._v("CTRL")])])},function(){var t=this,e=t._self._c;t._self._setupProxy;return e("thead",[e("tr",[e("th",{attrs:{colspan:"3"}},[t._v("Grid")])])])},function(){var t=this,e=t._self._c;t._self._setupProxy;return e("thead",[e("tr",[e("th",{attrs:{colspan:"3"}},[t._v("Image")])])])}],n=i(655),r=i(195),o="#version 300 es\n\nprecision mediump float;\n\nuniform vec3 u_grid;\nuniform vec4 u_image;\nuniform sampler2D u_target;\n\nout vec4 outColor;\n\nbool CellBorder(float x)\n{\n  return mod(x, u_grid.z) == 1.f;\n}\nvoid main() \n{\n  vec2 p = gl_FragCoord.xy - 0.5f;\n  ivec2 textSize = textureSize(u_target, 0);\n  if (CellBorder(u_grid.x - p.x) || CellBorder(u_grid.y - p.y))\n  {\n    outColor = vec4(0, 0, 0, 1);\n  } \n  else if (textSize != ivec2(1, 1))\n  {\n    float aspect = float(textSize.x) / float(textSize.y);\n\n    float s = sin(u_image.z);\n    float c = cos(u_image.z);\n\n    mat2 rot = mat2(c, -s, s, c);\n    mat2 scale = mat2(aspect, 0, 0, 1);\n    mat2 scaleInv = mat2(1.0 / aspect, 0, 0, 1);\n\n    vec2 texPos = p / vec2(textSize.x, textSize.y) / u_image.w - 0.5 - u_image.xy / u_image.w / vec2(textSize.x, textSize.y);\n    texPos = scaleInv * rot * scale * texPos ;\n    texPos += 0.5;\n\n    texPos.y = 1.0 - texPos.y;\n    \n    if (texPos.x >= 0.f && texPos.x <= 1.f && texPos.y >= 0.f && texPos.y <= 1.f)\n    {\n      outColor = texture(u_target, texPos);     \n    }\n    else\n    {\n      outColor = vec4(1);\n    }\n  }\n  else\n  {\n    outColor = vec4(1);\n  }\n}",h="#version 300 es\nin vec2 a_vertex;\n\nvoid main() \n{\n  gl_Position = vec4(a_vertex, 0, 1);\n}",g=i(615);class l{static ToRadians(t){return t/180*Math.PI}static ToDegrees(t){return t/Math.PI*180}static Vec0Pi(t,e,i,a){const s={X:e.X-t.X,Y:e.Y-t.Y},n={X:a.X-i.X,Y:a.Y-i.Y},r=s.X*n.X+s.Y*n.Y,o=Math.sqrt(s.X*s.X+s.Y*s.Y),h=Math.sqrt(n.X*n.X+n.Y*n.Y);return Math.acos(r/(o*h))}}class c{defaultStep;upperBound;acceleration;resetTimeout;step;prevActionTimestamp=0;constructor(t,e,i,a){this.defaultStep=t,this.upperBound=e,this.acceleration=i,this.resetTimeout=a,this.step=t}Step(){return this.NeedAccelerate?this.step+this.acceleration<=this.upperBound&&(this.step+=this.acceleration):this.step=this.defaultStep,this.prevActionTimestamp=Date.now(),this.step}get NeedAccelerate(){return Date.now()-this.prevActionTimestamp<=this.resetTimeout}}function d(t,e){const i=document.createElement("a");i.href=t,i.download=e,i.click()}async function m(t,e){return new Promise((i=>t.addEventListener(e,i,{once:!0})))}var u,f=i(695);(function(t){t[t["X"]=0]="X",t[t["Y"]=1]="Y"})(u||(u={}));let p=class extends r.w3{app;gl;vao=null;vbo=null;gridState=[0,0,100];imageState=[0,0,0,1];width=800;height=600;imgRealDimension={width:0,height:0};scroll=new c(.01,.7,.05,25);view;async mounted(){this.FillWindow(),window.addEventListener("resize",(()=>this.FillWindow())),this.app=new f.s(this.gl),this.app.Attach(this.gl.FRAGMENT_SHADER,o),this.app.Attach(this.gl.VERTEX_SHADER,h),this.app.Link(),this.app.Use(),this.SetupBackground(),this.SetupImage(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.app.SetUniform3fv("u_grid",this.gridState),this.app.SetUniform4fv("u_image",this.imageState),this.gl.bindVertexArray(this.vao),window.requestAnimationFrame((()=>this.Draw()))}beforeDestroy(){console.log("unsubscribe from resize event")}OnContextReady(t){this.gl=t}SetupBackground(){const t=[-1,-1,1,-1,1,1,1,1,-1,1,-1,-1];this.vao=this.gl.createVertexArray(),this.vbo=this.gl.createBuffer(),this.gl.bindVertexArray(this.vao),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vbo),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW);const e=this.app.GetAttributeLocation("a_vertex");this.app.SetUniform1i("u_target",0),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,2,this.gl.FLOAT,!1,0,0),this.gl.bindVertexArray(null)}SetupImage(){const t=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)}Draw(){this.gl.drawArrays(this.gl.TRIANGLES,0,6),window.requestAnimationFrame((()=>this.Draw()))}OnWheel(t,e,i){e?this.OnImageScale(t):i?this.OnImageRotate(t):this.OnGridScale(t)}OnMouseMove(t,e,i,a){1&t&&(e?this.OnImageMove(i,-1*a):this.OnGridMove(i,-1*a))}OnGridScale(t){const e=1;t<0?this.GridScale=this.gridState[2]+e:this.gridState[2]>10&&(this.GridScale=this.gridState[2]-e)}OnImageScale(t){const e=this.scroll.Step();t<0?this.ImageScale=this.imageState[3]+e:this.ImageScale-e>.2&&(this.ImageScale=this.imageState[3]-e)}OnImageRotate(t){const e=2*Math.PI/360,i=2*Math.PI;t>0?this.ImageAngle=(this.imageState[2]+e)%i:this.imageState[2]<e?this.ImageAngle=i-(e-this.imageState[2]):this.ImageAngle=this.imageState[2]-e}OnGridMove(t,e){this.$set(this.gridState,0,this.gridState[0]+t),this.$set(this.gridState,1,this.gridState[1]+e)}OnImageMove(t,e){this.ImageOffset={x:this.imageState[0]+t,y:this.imageState[1]+e}}set ImageOffset(t){this.$set(this.imageState,0,t.x),this.$set(this.imageState,1,t.y)}get ImageOffset(){return{x:this.imageState[0],y:this.imageState[1]}}set GridScale(t){this.$set(this.gridState,2,t)}get GridScale(){return this.gridState[2]}set ImageScale(t){this.$set(this.imageState,3,t)}get ImageScale(){return this.imageState[3]}get ImageAngle(){return this.imageState[2]}set ImageAngle(t){this.$set(this.imageState,2,t)}get ImageAngleDegrees(){return l.ToDegrees(this.ImageAngle)}get ImageDimension(){return{width:this.imgRealDimension.width*this.imageState[3],height:this.imgRealDimension.height*this.imageState[3]}}get NoImage(){return 0===this.imgRealDimension.width}OnGridUpdate(){this.app.SetUniform3fv("u_grid",this.gridState)}OnImageUpdate(){this.app.SetUniform4fv("u_image",this.imageState)}async OnLoadImage(t){const e=new Image;e.src=URL.createObjectURL(t),await m(e,"load"),this.imgRealDimension={width:e.width,height:e.height},this.ImageOffset={x:0,y:0},this.ImageScale=this.AutoScale(e.width,e.height),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e)}AutoScale(t,e){return t>e?this.width/t:this.height/e}FillWindow(){this.width=window.innerWidth,this.height=window.innerHeight}CenterImage(){this.ImageOffset={x:this.width/2-this.ImageDimension.width/2,y:this.height/2-this.ImageDimension.height/2}}AlignToGrid(){this.AlignImageToCellBegin(),this.FitImageToGrid()}AlignImageToCellBegin(){this.ImageOffset={x:this.AlignedToNearVertice(this.imageState[u.X],u.X),y:this.AlignedToNearVertice(this.imageState[u.Y],u.Y)}}AlignedToNearVertice(t,e){const i=this.gridState[e]>=0?this.gridState[e]%this.gridState[2]:this.gridState[2]- -this.gridState[e]%this.gridState[2],a=(t-i)%this.gridState[2],s=this.gridState[2]/2;return t+(a<s?-a:this.gridState[2]-a)}FitImageToGrid(){const t=this.imageState[0]+this.ImageDimension.width,e=this.imageState[1]+this.ImageDimension.height;let i=this.AlignedToNearVertice(t,u.X),a=this.AlignedToNearVertice(e,u.Y);(Math.abs(i-this.imageState[0])<=Number.EPSILON||Math.abs(a-this.imageState[1])<=Number.EPSILON)&&(i+=this.gridState[2],a+=this.gridState[2]),Math.abs(t-i)<Math.abs(e-a)?this.imageState[3]=(i-this.imageState[0])/this.imgRealDimension.width:this.imageState[3]=(a-this.imageState[1])/this.imgRealDimension.height}Preview(){d(this.view.canvas.toDataURL(),"image.png")}};(0,n.gn)([(0,r.Rl)()],p.prototype,"view",void 0),(0,n.gn)([(0,r.RL)("gridState")],p.prototype,"OnGridUpdate",null),(0,n.gn)([(0,r.RL)("imageState")],p.prototype,"OnImageUpdate",null),p=(0,n.gn)([(0,r.wA)({components:{Viewport:g.Z}})],p);var S=p,v=S,_=i(736),w=(0,_.Z)(v,a,s,!1,null,"7c65c3c4",null),x=w.exports},615:function(t,e,i){i.d(e,{Z:function(){return d}});var a=function(){var t=this,e=t._self._c;t._self._setupProxy;return e("canvas",{ref:"canvas",style:{width:t.Width,height:t.Height}})},s=[],n=i(655),r=i(195);let o=class extends r.w3{width;height;preserveDrawingBuffer;canvas;ContextReady(t){}context=null;get Width(){return this.width+"px"??"100%"}get Height(){return this.height+"px"??"100%"}async mounted(){this.context=this.canvas.getContext("webgl2",{preserveDrawingBuffer:this.preserveDrawingBuffer}),null!==this.context?(this.UpdateViewport(),this.context.enable(this.context.CULL_FACE),this.context.enable(this.context.DEPTH_TEST),this.ContextReady(this.context)):console.error("Can't initialize webgl2 context")}OnWidth(){this.UpdateViewport()}OnHeight(){this.UpdateViewport()}UpdateViewport(){this.canvas.width=this.width,this.canvas.height=this.height,this.context?.viewport(0,0,this.width,this.height)}};(0,n.gn)([(0,r.fI)()],o.prototype,"width",void 0),(0,n.gn)([(0,r.fI)()],o.prototype,"height",void 0),(0,n.gn)([(0,r.fI)({default:!1})],o.prototype,"preserveDrawingBuffer",void 0),(0,n.gn)([(0,r.Rl)()],o.prototype,"canvas",void 0),(0,n.gn)([(0,r.y1)("context-ready")],o.prototype,"ContextReady",null),(0,n.gn)([(0,r.RL)("width")],o.prototype,"OnWidth",null),(0,n.gn)([(0,r.RL)("height")],o.prototype,"OnHeight",null),o=(0,n.gn)([r.wA],o);var h=o,g=h,l=i(736),c=(0,l.Z)(g,a,s,!1,null,"13fb0e92",null),d=c.exports},695:function(t,e,i){function a(t){throw new Error(t)}i.d(e,{s:function(){return s}});class s{gl;uniformCache=new Map;instance;constructor(t){if(this.gl=t,!t)throw new Error("Invalid webgl2 context");this.instance=t.createProgram()??a("Can't create shader program")}Attach(t,e){const i=this.gl.createShader(t);if(null===i)throw new Error("Failed to create shader");if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){const t=new Error(this.gl.getShaderInfoLog(i)??"Failed to compile shader");throw this.gl.deleteShader(i),t}this.gl.attachShader(this.instance,i)}async AttachFromUrl(t,e){this.Attach(t,await(await fetch(e)).text())}Link(){if(this.gl.linkProgram(this.instance),!this.gl.getProgramParameter(this.instance,this.gl.LINK_STATUS)){const t=new Error(this.gl.getProgramParameter(this.instance,this.gl.LINK_STATUS)??"Failed to link shader");throw this.gl.deleteProgram(this.instance),t}}Use(){this.gl.useProgram(this.instance)}SetUniform3fv(t,e){this.gl.uniform3fv(this.GetUniformLocation(t),e)}SetUniform2fv(t,e){this.gl.uniform2fv(this.GetUniformLocation(t),e)}SetUniform4fv(t,e){this.gl.uniform4fv(this.GetUniformLocation(t),e)}SetUniform1f(t,e){this.gl.uniform1f(this.GetUniformLocation(t),e)}SetUniform1i(t,e){this.gl.uniform1i(this.GetUniformLocation(t),e)}SetUniform2iv(t,e){this.gl.uniform2iv(this.GetUniformLocation(t),e)}GetAttributeLocation(t){this.Use();const e=this.gl.getAttribLocation(this.instance,t);if(-1===e)throw new Error(`Failed to locate attribute '${t}'`);return e}GetUniformLocation(t){this.Use();let e=this.uniformCache.get(t)??null;if(null===e){if(e=this.gl.getUniformLocation(this.instance,t),null===e)throw new Error(`Failed to locate uniform '${t}'`);this.uniformCache.set(t,e)}return e}}}}]);
//# sourceMappingURL=grid.71d034e3.js.map